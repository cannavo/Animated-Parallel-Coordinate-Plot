<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
	<script src="https://d3js.org/d3.v4.min.js"></script>
	<script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
	<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
	<script>
		function load(){
			var height=400 
			var width=200 
			var ax=["wheel-base","length","width","price","curb-weight","engine-size","highway-mpg","city-mpg"];
			
			var back=[];
			var data=[];
			ax.forEach(function(d,i){
				back.push({type: "line", x1: 100+i*width , y1: 40 , x2: 100+i*width, y2: height+40});
			});
			opts=["normalized-losses","wheel-base","length","width","height","curb-weight","engine-size","bore","stroke","compression-ratio","horsepower","peak-rpm","city-mpg","highway-mpg","price"];
			var select = d3.select('body').append('select').attr('id','select');
			var opt = d3.select('body').append('select').attr('id','opt');
			opt.selectAll('#opt').data(opts).enter().append('option').text(function (d) { return d; }).attr("value",function (d) { return d; });;
			var but = d3.select('body').append('button').attr('id','update').text("Update").on("click",update);
			var svg = d3.select("body").append("svg")
			var opt2 = d3.select('body').append('select').attr('id','opt2');
			opt2.selectAll('#opt2').data(opts).enter().append('option').text(function (d) { return d; }).attr("value",function (d) { return d; });;
			var but = d3.select('body').append('button').attr('id','add').text("Add").on("click",add);
			draw();
			function draw() {
				svg.attr("width", 200+width*(ax.length-1)).attr("height", height+75);
				var daxis=[]
				for (var i=0;i<ax.length;i++) {
					daxis.push(i+"")
				}
				select.selectAll("*").remove()
				slct=select.selectAll('options').data(daxis)
				slct.enter().append('option').text(function (d) { return d; }).attr("value",function (d) { return d; })
				var back=[];
				ax.forEach(function(d,i){
					back.push({type: "line", x1: 100+i*width , y1: 40 , x2: 100+i*width, y2: height+40});
					for (var j=0;j<6;j++) {
						back.push({type: "line", x1: 90+i*width , y1: 40+(height/5)*j , x2: 100+i*width, y2: 40+(height/5)*j});
					}
				});
				let lines = svg.selectAll("line").data(back);
				
				var xd=[]
				lines.enter()
					   .append("line")
					   .attr("x1",function(d){return d.x1;})
					   .attr("y1",function(d){return d.y1;})
					   .attr("x2",function(d){return d.x2;})
					   .attr("y2",function(d){return d.y2;})
					   .style("stroke","black")
					   .style("stroke-width","2")
				var id=0
				lines.enter()
					   .append("line")
					   .attr("x1",function(d){xd=d.x1; return d.x1;})
					   .attr("y1",function(d){return d.y1;})
					   .attr("x2",function(d){return d.x2;})
					   .attr("y2",function(d){return d.y2;})
					   .style("stroke","black")
					   .style("stroke-width","20")
					   .style("opacity",0)
					   .style("cursor","grab")
					   .on("mousedown", function(){
							var p = d3.mouse( this);
							svg.append( "rect")
							.attr("x",d3.select(this).attr("x1")-10)
							.attr("y",p[1])
							.attr("width",20)
							.attr("height",0)
							.attr("id","a"+id)
							.attr("class","sel")
							.style("fill","grey")
							.style("opacity",0.5);
							})
						.on("mousemove",function(){
							var s = svg.select("#a"+id);
							if(!s.empty()){
								var p = d3.mouse(this);
								if(p[1]>s.attr("y")){
									s.attr("height",p[1]-s.attr("y")-1);
								}
							}
						})
						.on( "mouseup", function() {
							var s = svg.select("#a"+id);
							id+=1;
							updateLines(parseInt(s.attr("y")),parseInt(s.attr("height"))+parseInt(s.attr("y")),Math.floor(d3.select(this).attr("x1")/width));
						});
						
				m={"normalized-losses":[-1,-1,-1],"wheel-base":[-1,-1,-1],"length":[-1,-1,-1],"width":[-1,-1,-1],"height":[-1,-1,-1],"curb-weight":[-1,-1,-1],"engine-size":[-1,-1,-1],"bore":[-1,-1,-1],"stroke":[-1,-1,-1],"compression-ratio":[-1,-1,-1],"horsepower":[-1,-1,-1],"peak-rpm":[-1,-1,-1],"city-mpg":[-1,-1,-1],"highway-mpg":[-1,-1,-1],"price":[-1,-1,-1]};
				var front=[];
				d3.json("data.json",function(error,d){
					d.forEach(function(da,i){
						for (let [k, v] of Object.entries(m)) {
							if (v[0]==-1){
								v[0]=da[k]
							}
							if (v[1]==-1){
								v[1]=da[k]
							}
							if(v[0]<da[k]){
								v[0]=da[k]
							}
							if(v[1]>da[k]){
								v[1]=da[k]
							}
							v[2]=v[0]-v[1]
						}
						data.push(da)
					});
					d.forEach(function(da,index){
						for (var i = 0; i < ax.length-1; i++) {
							var ys=(((da[ax[i]]-m[ax[i]][1])/m[ax[i]][2])*height)+40
							var xs=i*width+100
							var ye=(((da[ax[i+1]]-m[ax[i+1]][1])/m[ax[i+1]][2])*height)+40
							var xe=(i+1)*width+100
							front.push({type: "line", x1: xs , y1: ys, x2: xe, y2: ye,key: index+" "+i,idx:index})	
						}
					});
					drawLines()
					drawAxis()
				});
				function drawLines() {
					let lines2 = svg.selectAll("line").data(front,function (d) {return d.key;});
					lines2.enter()
						   .append("line")
						   .attr("x1",function(d){return (d.x1);})
						   .attr("y1",function(d){return (d.y1);})
						   .attr("x2",function(d){return (d.x2);})
						   .attr("y2",function(d){return (d.y2);})
						   .attr("class","in")
						   .style("stroke","blue")
						   .style("stroke-width",".4");	
				}
				function drawAxis() {
					t=[]
					ax.forEach(function(d,i){
						t.push({type: "text", x: i*width+100, y:15, text: d})
						for (var j=0;j<6;j++) {
							t.push({type: "text", x: i*width+70, y:45+(height/5)*j, text: Math.round(m[d][1]+(m[d][2]/5)*j)})
						}
					});	
					let text = svg.selectAll(".label").data(t);
					text.enter()
						   .append("text")
						   .attr("x",function(d){return d.x;})
						   .attr("y",function(d){return d.y;})
						   .attr("text-anchor","middle")
						   .attr("class","label")
						   .text(function(d){return d.text;});
					del=[];
					ax.forEach(function(d,i){
						del.push(i*width+100);
					});
					let text2 = svg.selectAll("delete").data(del);
					text2.enter()
						   .append("text")
						   .attr("x",function(d){return d;})
						   .attr("y",height+70)
						   .attr("text-anchor","middle")
						   .text("remove")
						   .style('fill', 'red')
						   .style("cursor","pointer")
						   .on("click",function(d){
								ax.splice(Math.floor(d/width),1);
								svg.selectAll("*").remove();
								draw();
						   });
				}
				function updateLines(y1,y2,idx){
					up=[];
					data.forEach(function(da,index){
						if ((((((da[ax[idx]]-m[ax[idx]][1])/m[ax[idx]][2])*height)+40)>=y1)&&((((((da[ax[idx]]-m[ax[idx]][1])/m[ax[idx]][2])*height)+40)<=y2))) {
							for (var i = 0; i < ax.length-1; i++) {
								var ys=(((da[ax[i]]-m[ax[i]][1])/m[ax[i]][2])*height)+40
								var xs=i*width+100
								var ye=(((da[ax[i+1]]-m[ax[i+1]][1])/m[ax[i+1]][2])*height)+40
								var xe=(i+1)*width+100
								up.push({type: "line", x1: xs , y1: ys, x2: xe, y2: ye,key: index+" "+i,idx: index})	
							}
						}
					});
					let ulines = svg.selectAll(".in").data(up,function (d) {return d.key;});
					ulines.enter()
						   .append("line")
						   .attr("x1",function(d){return (d.x1);})
						   .attr("y1",function(d){return (d.y1);})
						   .attr("x2",function(d){return (d.x2);})
						   .attr("y2",function(d){return (d.y2);})
						   .attr("class","in")
						   .style("stroke","blue")
						   .style("stroke-width",".4");	
					ulines.exit()
							.transition()
							.delay(.0001)
							.duration(500)
							.style("stroke","grey")
							.style("opacity",.25) 
				}
			}
			function update(){
					x=d3.select("#select").property("value");
					nax=d3.select("#opt").property("value");
					t=svg.selectAll(".label")
					t.text(function(d){
								if(d.x==x*width+100 || d.x==x*width+70){
									if (d.y==15) {
										return nax;
									}
									for (var j=0;j<6;j++){
										if(d.y==45+(height/5)*j) {
											return Math.round(m[nax][1]+(m[nax][2]/5)*j);
										}
									}
								}
								else{
									return d.text;
								}
						   });
					
					function y1Tween(d,index,self) {
						var interpolate;
						if(d.x1==x*width+100){
							var ysn=(((data[d.idx][nax]-m[nax][1])/m[nax][2])*height)+40
							interpolate = d3.interpolateNumber(d.y1,ysn);
							d.y1=ysn;
						}
						else
						{
							interpolate =d3.interpolateNumber(d.y1,d.y1)
						}
						return function(t) {
							return interpolate(t);
						}
					}	
					function y2Tween(d,index,self) {
						var interpolate;
						if(d.x2==x*width+100){
							var ysn=(((data[d.idx][nax]-m[nax][1])/m[nax][2])*height)+40
							interpolate = d3.interpolateNumber(d.y2,ysn);
							d.y2=ysn;
						}
						else
						{
							interpolate =d3.interpolateNumber(d.y2,d.y2)
						}
						return function(t) {
							return interpolate(t);
						}
					}	
					svg.selectAll(".in")
						.transition()
						.delay(.000001)
						.duration(1000)
						.attrTween("y1",y1Tween)
						.attrTween("y2",y2Tween)
					ax[x]=nax
				}
				function add() {
					nax=d3.select("#opt2").property("value");
					ax.push(nax)
					svg.selectAll("*").remove();
					draw();
				}
		}
		
		function reset(){
			d3.selectAll(".sel").remove();
			d3.selectAll(".in")
						.style("stroke",function(d){d.stroke="blue";return "blue"})
						.style("opacity",function(d){d.opacity=1;return 1});
			
		}
	</script>
</head>
<body onLoad="load()">
	<button onclick = "reset()">Reset</button>
</body>
</html>